package com.love2loveapp.ui.views.dailychallenge

import androidx.compose.foundation.layout.Box
import androidx.compose.foundation.layout.Column
import androidx.compose.foundation.layout.fillMaxSize
import androidx.compose.foundation.layout.padding
import androidx.compose.material3.CircularProgressIndicator
import androidx.compose.material3.MaterialTheme
import androidx.compose.material3.Text
import androidx.compose.runtime.Composable
import androidx.compose.runtime.LaunchedEffect
import androidx.compose.runtime.collectAsState
import androidx.compose.runtime.getValue
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.text.style.TextAlign
import androidx.compose.ui.unit.dp
import androidx.lifecycle.viewmodel.compose.viewModel
import com.love2loveapp.core.viewmodels.IntegratedAppState
import com.love2loveapp.core.viewmodels.ConnectedDailyChallengeViewModel
import com.love2loveapp.di.ServiceContainer
import com.love2loveapp.model.DailyContentRoute
import com.love2loveapp.ui.components.IntegratedErrorView
import com.love2loveapp.ui.components.IntegratedLoadingView

/**
 * ðŸŽ¯ IntegratedDailyChallengeView - Vue IntÃ©grÃ©e avec Navigation Automatique
 * 
 * ResponsabilitÃ©s :
 * - Navigation automatique basÃ©e sur NavigationManager
 * - Ã‰tats rÃ©actifs depuis IntegratedAppState
 * - Injection de dÃ©pendances via ServiceContainer
 * - UI purement dÃ©clarative sans logique mÃ©tier
 * 
 * Architecture : Compose + State-Driven UI + Automatic Navigation
 */
@Composable
fun IntegratedDailyChallengeView(
    integratedAppState: IntegratedAppState,
    onShowSubscription: () -> Unit,
    onNavigateToSavedChallenges: () -> Unit,
    modifier: Modifier = Modifier,
    viewModel: ConnectedDailyChallengeViewModel = viewModel { 
        ServiceContainer.createDailyChallengeViewModel() 
    }
) {
    // Configuration automatique du ViewModel
    LaunchedEffect(integratedAppState) {
        viewModel.configureWithAppState(integratedAppState)
    }
    
    // Ã‰tats observables depuis NavigationManager (via IntegratedAppState)
    val currentRoute by integratedAppState.currentDailyChallengeRoute.collectAsState()
    
    // Ã‰tats observables depuis ViewModel
    val currentChallenge by viewModel.currentChallenge.collectAsState()
    val isLoading by viewModel.isLoading.collectAsState()
    val errorMessage by viewModel.errorMessage.collectAsState()
    val canAccessPremium by viewModel.canAccessPremiumChallenges.collectAsState()
    
    // UI rÃ©active basÃ©e sur la route calculÃ©e automatiquement
    Box(modifier = modifier.fillMaxSize()) {
        when (currentRoute) {
            is DailyContentRoute.Intro -> {
                IntegratedDailyChallengeIntroView(
                    showConnectButton = currentRoute.showConnect,
                    onConnectPartner = {
                        // TODO: Navigation vers connexion partenaire
                    },
                    onContinue = {
                        // Marquer intro comme vue
                        integratedAppState.navigationManager.markIntroAsSeen(
                            com.love2loveapp.model.DailyContentRouteCalculator.ContentType.DAILY_CHALLENGE
                        )
                    }
                )
            }
            
            is DailyContentRoute.Main -> {
                IntegratedDailyChallengeMainView(
                    currentChallenge = currentChallenge,
                    isLoading = isLoading,
                    canAccessPremium = canAccessPremium,
                    onChallengeCompleted = { challengeId ->
                        viewModel.markChallengeAsCompleted(challengeId)
                    },
                    onShowSavedChallenges = onNavigateToSavedChallenges,
                    onRefresh = {
                        viewModel.refreshData()
                    }
                )
            }
            
            is DailyContentRoute.Paywall -> {
                IntegratedDailyChallengePaywallView(
                    challengeDay = currentRoute.day,
                    onShowSubscription = onShowSubscription,
                    onDismiss = {
                        // Retour Ã  l'Ã©tat prÃ©cÃ©dent
                        integratedAppState.navigationManager.forceNavigateToDailyChallengeMain()
                    }
                )
            }
            
            is DailyContentRoute.Error -> {
                IntegratedErrorView(
                    title = "Erreur Daily Challenge",
                    message = currentRoute.message,
                    onRetry = {
                        viewModel.refreshData()
                    },
                    onDismiss = {
                        viewModel.clearError()
                    }
                )
            }
            
            is DailyContentRoute.Loading -> {
                IntegratedLoadingView(
                    message = "Chargement de votre dÃ©fi..."
                )
            }
        }
        
        // Afficher erreur en overlay si prÃ©sente
        errorMessage?.let { error ->
            IntegratedErrorView(
                title = "Erreur",
                message = error,
                onRetry = {
                    viewModel.refreshData()
                },
                onDismiss = {
                    viewModel.clearError()
                },
                modifier = Modifier.align(Alignment.Center)
            )
        }
    }
}

/**
 * Vue d'introduction Daily Challenge
 */
@Composable
private fun IntegratedDailyChallengeIntroView(
    showConnectButton: Boolean,
    onConnectPartner: () -> Unit,
    onContinue: () -> Unit,
    modifier: Modifier = Modifier
) {
    Column(
        modifier = modifier
            .fillMaxSize()
            .padding(16.dp),
        horizontalAlignment = Alignment.CenterHorizontally
    ) {
        Text(
            text = "Bienvenue dans Daily Challenge",
            style = MaterialTheme.typography.headlineMedium,
            textAlign = TextAlign.Center
        )
        
        Text(
            text = "Relevez des dÃ©fis quotidiens avec votre partenaire pour renforcer votre relation.",
            style = MaterialTheme.typography.bodyLarge,
            textAlign = TextAlign.Center,
            modifier = Modifier.padding(vertical = 16.dp)
        )
        
        if (showConnectButton) {
            androidx.compose.material3.Button(
                onClick = onConnectPartner,
                modifier = Modifier.padding(vertical = 8.dp)
            ) {
                Text("Connecter mon partenaire")
            }
        } else {
            androidx.compose.material3.Button(
                onClick = onContinue,
                modifier = Modifier.padding(vertical = 8.dp)
            ) {
                Text("Commencer")
            }
        }
    }
}

/**
 * Vue principale Daily Challenge
 */
@Composable
private fun IntegratedDailyChallengeMainView(
    currentChallenge: com.love2loveapp.model.DailyChallenge?,
    isLoading: Boolean,
    canAccessPremium: Boolean,
    onChallengeCompleted: (String) -> Unit,
    onShowSavedChallenges: () -> Unit,
    onRefresh: () -> Unit,
    modifier: Modifier = Modifier
) {
    Column(
        modifier = modifier
            .fillMaxSize()
            .padding(16.dp)
    ) {
        if (isLoading) {
            Box(
                modifier = Modifier.fillMaxSize(),
                contentAlignment = Alignment.Center
            ) {
                CircularProgressIndicator()
            }
        } else if (currentChallenge != null) {
            // Afficher le dÃ©fi
            Text(
                text = currentChallenge.title,
                style = MaterialTheme.typography.headlineSmall,
                modifier = Modifier.padding(bottom = 16.dp)
            )
            
            Text(
                text = currentChallenge.description,
                style = MaterialTheme.typography.bodyLarge,
                modifier = Modifier.padding(bottom = 24.dp)
            )
            
            if (!currentChallenge.isCompleted) {
                androidx.compose.material3.Button(
                    onClick = { onChallengeCompleted(currentChallenge.id) },
                    modifier = Modifier.padding(bottom = 16.dp)
                ) {
                    Text("Marquer comme terminÃ©")
                }
            } else {
                Text(
                    text = "âœ… DÃ©fi terminÃ© !",
                    style = MaterialTheme.typography.bodyLarge,
                    color = MaterialTheme.colorScheme.primary,
                    modifier = Modifier.padding(bottom = 16.dp)
                )
            }
        } else {
            // Aucun dÃ©fi disponible
            Text(
                text = "Aucun dÃ©fi disponible aujourd'hui",
                style = MaterialTheme.typography.bodyLarge,
                textAlign = TextAlign.Center,
                modifier = Modifier.padding(24.dp)
            )
        }
        
        // Actions
        androidx.compose.material3.OutlinedButton(
            onClick = onShowSavedChallenges,
            modifier = Modifier.padding(vertical = 8.dp)
        ) {
            Text("Voir les dÃ©fis sauvegardÃ©s")
        }
        
        androidx.compose.material3.TextButton(
            onClick = onRefresh,
            modifier = Modifier.padding(vertical = 4.dp)
        ) {
            Text("Actualiser")
        }
    }
}

/**
 * Vue paywall Daily Challenge
 */
@Composable
private fun IntegratedDailyChallengePaywallView(
    challengeDay: Int,
    onShowSubscription: () -> Unit,
    onDismiss: () -> Unit,
    modifier: Modifier = Modifier
) {
    Column(
        modifier = modifier
            .fillMaxSize()
            .padding(16.dp),
        horizontalAlignment = Alignment.CenterHorizontally
    ) {
        Text(
            text = "DÃ©fi Premium",
            style = MaterialTheme.typography.headlineMedium,
            textAlign = TextAlign.Center
        )
        
        Text(
            text = "Vous avez atteint le dÃ©fi jour $challengeDay. DÃ©bloquez l'accÃ¨s premium pour continuer !",
            style = MaterialTheme.typography.bodyLarge,
            textAlign = TextAlign.Center,
            modifier = Modifier.padding(vertical = 16.dp)
        )
        
        androidx.compose.material3.Button(
            onClick = onShowSubscription,
            modifier = Modifier.padding(vertical = 8.dp)
        ) {
            Text("DÃ©bloquer Premium")
        }
        
        androidx.compose.material3.TextButton(
            onClick = onDismiss,
            modifier = Modifier.padding(vertical = 4.dp)
        ) {
            Text("Plus tard")
        }
    }
}
